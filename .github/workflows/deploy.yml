name: Deploy to GitHub Pages

on:
  # Trigger on push to main branches
  push:
    branches: [ "main", "master" ]
  
  # Allow manual trigger from Actions tab
  workflow_dispatch:

# Grant write permission to push to the gh-pages branch
permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # ========================================================
      # 1. Checkout Source Code
      # ========================================================
      - name: Checkout Code
        uses: actions/checkout@v4

      # ========================================================
      # 2. Inject Configuration (Secrets & Variables)
      # ========================================================
      - name: Inject Environment Variables
        env:
          # Priority: Secrets > Variables (Repository Settings)
          INPUT_EMAIL: ${{ secrets.MY_EMAIL || vars.MY_EMAIL }}
          INPUT_GITHUB: ${{ secrets.MY_GITHUB || vars.MY_GITHUB }}
        run: |
          # Check if index.html exists before processing
          if [ ! -f index.html ]; then
            echo "Error: index.html not found!"
            exit 1
          fi

          echo "Processing configuration injection..."

          # Apply defaults using Bash parameter expansion if inputs are empty
          # Note: JS also has fallback logic, this is for static persistence.
          REAL_EMAIL="${INPUT_EMAIL:-void@dimension.null}"
          REAL_GITHUB="${INPUT_GITHUB:-https://github.com}"

          # Execute replacement using sed with '|' delimiter to handle URLs safely
          sed -i "s|{{MY_EMAIL}}|$REAL_EMAIL|g" index.html
          sed -i "s|{{MY_GITHUB}}|$REAL_GITHUB|g" index.html

          echo "Configuration injected successfully."

      # ========================================================
      # 3. Deploy to GitHub Pages
      # ========================================================
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: .           # Root directory to deploy
          branch: gh-pages    # Target branch
          clean: true         # Automatically remove deleted files from target
